<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Start Page</title>
  <style>
    :root{
      --bg: #0b0c0f;
      --bg-elev: #12141a;
      --text: #e6e9ef;
      --muted: #9aa3b2;
      --accent: #4f8cff;
      --card: #171922;
      --ring: #4f8cff55;
      --danger: #ff5c7a;
      --ok: #26c281;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --bg-elev: #fff;
        --text: #0c0d0f;
        --muted: #5a6473;
        --accent: #2b6cff;
        --card: #ffffff;
        --ring: #2b6cff44;
        --danger: #d62839;
        --ok: #209f5e;
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background: radial-gradient(1200px 800px at 100% -10%, #2a2f45 0%, transparent 60%), var(--bg);
      display:flex; flex-direction:column; min-height:100%;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: saturate(140%) blur(8px);
      background: color-mix(in oklab, var(--bg-elev) 70%, transparent);
      border-bottom: 1px solid color-mix(in oklab, var(--muted) 25%, transparent);
    }
    .wrap{ max-width: 1100px; margin: 0 auto; padding: 16px; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .title{ font-weight:700; letter-spacing:.2px; font-size: clamp(18px, 3vw, 22px); margin-right:auto; display:flex; align-items:center; gap:10px; }
    .title input{
      background: transparent; border:none; outline:none; color:var(--text); font: inherit; border-bottom:1px dashed color-mix(in oklab, var(--text) 40%, transparent);
      width: min(360px, 50vw);
    }
    .btn{
      appearance:none; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); background: var(--bg-elev);
      color:var(--text); padding:8px 12px; border-radius: 10px; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition: .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 6px 18px -10px var(--ring); }
    .btn[aria-pressed="true"], .btn.primary{ border-color: transparent; background: linear-gradient(180deg, color-mix(in oklab, var(--accent) 20%, var(--bg-elev)), var(--accent)); color:white; }
    .btn.danger{ background: linear-gradient(180deg, color-mix(in oklab, var(--danger) 15%, var(--bg-elev)), var(--danger)); color:white; border-color:transparent; }
    .btn.flat{ background: transparent; border-color: transparent; }

    .grid{
      display:grid; gap:14px; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
      padding: 22px 16px 30px; width: min(1100px, 100%); margin: 0 auto; flex:1;
    }

    /* Full-image card tile (fixed: rely on aspect-ratio for height) */
    .card{
      position:relative;
      background: var(--card);
      border:1px solid color-mix(in oklab, var(--muted) 22%, transparent);
      border-radius: 16px; overflow:hidden;
      cursor:pointer;
      display:block;
    }
    .card:hover{ box-shadow: 0 10px 30px -18px var(--ring); transform: translateY(-1px); }

    /* The visual area: height is derived from width via aspect-ratio */
    .thumb{
      width:100%;
      aspect-ratio: 16 / 10; /* controls card height; tweak if you want taller/shorter tiles */
      display:grid; place-items:center;
      background:
        linear-gradient(180deg, color-mix(in oklab, var(--bg) 70%, transparent), transparent),
        var(--bg-elev);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: contain;   /* keeps aspect ratio, no cropping */
      display:block;
    }

    .fallback-initial{
      font-weight:800; font-size: 48px; line-height:1; opacity:.9;
      color: color-mix(in oklab, var(--text) 88%, transparent);
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
      user-select:none;
    }

    .caption{
      position:absolute; left:0; right:0; bottom:0;
      background: linear-gradient(180deg, transparent, color-mix(in oklab, #000 55%, var(--bg-elev)));
      padding: 10px 12px 12px;
      display:flex; flex-direction:column; gap:2px;
    }
    .name{ font-weight:700; text-shadow: 0 2px 10px rgba(0,0,0,.35); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .url{ font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Edit mode overlay controls */
    .edit-badges{ position:absolute; inset:10px auto auto 10px; display:flex; gap:6px; z-index:2; }
    .pill{ font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); background: var(--bg-elev); color:var(--muted); }

    .actions{ position:absolute; inset:10px 10px auto auto; display:flex; gap:6px; z-index:2; }
    .icon-btn{ width:34px; height:34px; display:grid; place-items:center; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 35%, transparent); background: var(--bg-elev); cursor:pointer; }
    .icon-btn:hover{ box-shadow: 0 6px 18px -10px var(--ring); }

    .dragging{ opacity:.6; outline: 2px dashed var(--accent); }
    .drop-target{ outline: 2px dashed var(--accent); outline-offset: 4px; }

    dialog{
      border:none; border-radius: 16px; padding:0; box-shadow: 0 30px 60px -35px rgba(0,0,0,.6);
      background: var(--bg-elev); color:var(--text); width:min(560px, 96vw);
    }
    .dlg-head{ padding:16px 18px; border-bottom:1px solid color-mix(in oklab, var(--muted) 25%, transparent); font-weight:700; display:flex; justify-content:space-between; align-items:center; }
    .dlg-body{ padding:16px 18px; display:grid; gap:12px; }
    .field{ display:grid; gap:6px; }
    label{ font-size:12px; color:var(--muted); }
    input[type="text"], input[type="url"]{
      width:100%; padding:10px 12px; border-radius:10px; background: var(--bg); color: var(--text);
      border:1px solid color-mix(in oklab, var(--muted) 30%, transparent);
    }
    .icon-row{ display:grid; gap:8px; }
    .icon-tools{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .icon-preview{ width:48px; height:48px; border-radius:10px; border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); display:none; object-fit: contain; background: var(--bg); }
    .hint{ font-size:11px; color:var(--muted); }

    footer{ color:var(--muted); text-align:center; padding: 10px 0 22px; font-size: 12px; }
    .search{ position: relative; flex: 1 1 260px; min-width: 220px; }
    .search input{ width:100%; padding:10px 12px 10px 36px; border-radius:10px; background: var(--bg-elev); color: var(--text);
      border:1px solid color-mix(in oklab, var(--muted) 30%, transparent); }
    .search svg{ position:absolute; left:10px; top:50%; transform: translateY(-50%); opacity:.7 }
    .hidden{ display:none !important }
  </style>
</head>
<body>
  <header>
    <div class="wrap toolbar">
      <div class="title">
        <span>üè†</span>
        <input id="pageTitle" aria-label="Page title" />
      </div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
        <input id="search" placeholder="Filter links‚Ä¶ (‚åò/Ctrl+K)" autocomplete="off" />
      </div>
      <button class="btn" id="addBtn">‚ûï Add</button>
      <button class="btn" id="editToggle" aria-pressed="false">‚úèÔ∏è Edit mode</button>
      <button class="btn" id="exportBtn" title="Export as JSON">‚¨áÔ∏è Export</button>
      <label class="btn" for="importFile" title="Import from JSON">‚¨ÜÔ∏è Import<input id="importFile" type="file" accept="application/json" hidden></label>
      <button class="btn danger" id="resetBtn" title="Restore starter links">‚ü≤ Reset</button>
    </div>
  </header>

  <main class="grid" id="grid" aria-live="polite"></main>

  <footer>Data is stored locally in your browser (localStorage). No servers involved.</footer>

  <dialog id="editor">
    <form method="dialog" id="editorForm">
      <div class="dlg-head">
        <span id="dlgTitle">Add Link</span>
        <button class="btn flat" value="cancel" aria-label="Close">‚úï</button>
      </div>
      <div class="dlg-body">
        <div class="field">
          <label for="name">Name</label>
          <input id="name" name="name" type="text" required maxlength="80" />
        </div>
        <div class="field">
          <label for="url">URL</label>
          <input id="url" name="url" type="url" inputmode="url" placeholder="https://example.com" required />
        </div>
        <div class="field icon-row">
          <label for="icon">Icon / Image (optional)</label>
          <input id="icon" name="icon" type="text" inputmode="url"
                 placeholder="https://‚Ä¶  or  ./icons/mysite.png  or  data:image/png;base64,‚Ä¶" />
          <div class="icon-tools">
            <img id="iconPreview" class="icon-preview" alt="icon preview">
            <label class="btn" for="iconFile">üìÅ Choose file
              <input id="iconFile" type="file" accept="image/*" hidden>
            </label>
            <button class="btn flat" type="button" id="clearIconBtn" title="Remove custom icon">üßπ Clear</button>
          </div>
          <div class="hint">If no custom image is set, the site‚Äôs favicon is used. Cards display the image as large as possible without cropping or distortion.</div>
        </div>
      </div>
      <div class="dlg-foot">
        <button class="btn" value="cancel">Cancel</button>
        <button class="btn primary" id="saveBtn" value="default">Save</button>
      </div>
    </form>
  </dialog>

  <script>
  (function(){
    const STORE_KEY_V3 = 'favoriteLinks.v3';
    const STORE_KEY_V2 = 'favoriteLinks.v2';
    const STORE_KEY_V1 = 'favoriteLinks.v1';
    const TITLE_KEY = 'favoriteLinks.title';

    /** @typedef {{id:string,name:string,url:string,icon?:string}} Link */
    /** @type {Link[]} */
    let links = [];
    let editMode = false;
    let editingId = null;

    const grid = document.getElementById('grid');
    const editor = document.getElementById('editor');
    const editorForm = document.getElementById('editorForm');
    const dlgTitle = document.getElementById('dlgTitle');
    const nameInput = document.getElementById('name');
    const urlInput = document.getElementById('url');
    const iconInput = document.getElementById('icon');
    const iconFile = document.getElementById('iconFile');
    const iconPreview = document.getElementById('iconPreview');
    const clearIconBtn = document.getElementById('clearIconBtn');

    const addBtn = document.getElementById('addBtn');
    const editToggle = document.getElementById('editToggle');
    const exportBtn = document.getElementById('exportBtn');
    const importFile = document.getElementById('importFile');
    const resetBtn = document.getElementById('resetBtn');
    const searchInput = document.getElementById('search');
    const pageTitle = document.getElementById('pageTitle');

    const uid = () => Math.random().toString(36).slice(2, 9);
    const norm = s => (s||'').trim();
    const hostname = (u)=>{ try{ return new URL(u).hostname.replace(/^www\./,''); }catch{ return u; } };

    function starterData(){
      return [
        { id: uid(), name:'Google', url:'https://www.google.com' },
        { id: uid(), name:'YouTube', url:'https://www.youtube.com' },
        { id: uid(), name:'Reddit', url:'https://www.reddit.com' },
        { id: uid(), name:'Gmail', url:'https://mail.google.com' },
        { id: uid(), name:'GitHub', url:'https://github.com' },
        { id: uid(), name:'ChatGPT', url:'https://chat.openai.com' },
      ];
    }

    function readJSON(key, fallback=null){
      try{ return JSON.parse(localStorage.getItem(key)); }catch{ return fallback; }
    }
    function sanitizeLink(x){
      const name = norm(x?.name);
      const url  = norm(x?.url);
      const icon = norm(x?.icon || '');
      const id   = norm(x?.id) || uid();
      return icon ? { id, name, url, icon } : { id, name, url };
    }
    function migrate(){
      let v3 = readJSON(STORE_KEY_V3);
      if (Array.isArray(v3) && v3.length) return v3.map(sanitizeLink);
      let v2 = readJSON(STORE_KEY_V2);
      if (Array.isArray(v2) && v2.length) return v2.map(x => sanitizeLink({ id: uid(), name: x.name, url: x.url, icon: x.icon }));
      let v1 = readJSON(STORE_KEY_V1);
      if (Array.isArray(v1) && v1.length) return v1.map(x => sanitizeLink({ id: x.id || uid(), name: x.name, url: x.url }));
      return starterData();
    }

    function load(){
      links = migrate();
      pageTitle.value = localStorage.getItem(TITLE_KEY) || 'My Start Page';
    }
    function save(){ localStorage.setItem(STORE_KEY_V3, JSON.stringify(links)); }
    function saveTitle(){ localStorage.setItem(TITLE_KEY, pageTitle.value); }

    function googleFavicon(url){
      try{
        const u = new URL(url);
        return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(u.origin)}&sz=128`;
      }catch{ return null; }
    }

    function render(filterText=''){
      grid.innerHTML = '';
      const q = norm(filterText).toLowerCase();
      const list = q ? links.filter(l => l.name.toLowerCase().includes(q) || l.url.toLowerCase().includes(q)) : links;

      list.forEach((link, idx) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.draggable = editMode; card.dataset.id = link.id; card.setAttribute('aria-label', link.name);

        if(!editMode){
          card.setAttribute('role','link');
          card.tabIndex = 0;
          card.addEventListener('click', ()=> window.location.assign(link.url));
          card.addEventListener('auxclick', (e)=>{ if(e.button===1){ window.open(link.url, '_blank'); } });
          card.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ window.location.assign(link.url); } });
        }

        const thumb = document.createElement('div');
        thumb.className = 'thumb';

        const setFallback = ()=>{
          const fallback = document.createElement('div');
          fallback.className = 'fallback-initial';
          fallback.textContent = (link.name||'?').slice(0,1).toUpperCase();
          thumb.replaceChildren(fallback);
        };

        // Prefer custom icon, else google favicon, else big initial
        const iconSrc = norm(link.icon);
        if (iconSrc) {
          const img = document.createElement('img');
          img.alt = '';
          img.decoding = 'async';
          img.addEventListener('error', setFallback);
          img.src = iconSrc;
          thumb.appendChild(img);
        } else {
          const favUrl = googleFavicon(link.url);
          if (favUrl) {
            const img = document.createElement('img');
            img.alt = '';
            img.decoding = 'async';
            img.addEventListener('error', setFallback);
            img.src = favUrl;
            thumb.appendChild(img);
          } else {
            setFallback();
          }
        }

        const caption = document.createElement('div');
        caption.className = 'caption';
        const nameEl = document.createElement('div'); nameEl.className='name'; nameEl.textContent = link.name || '';
        const urlEl = document.createElement('div'); urlEl.className='url'; urlEl.textContent = hostname(link.url || '');
        caption.append(nameEl, urlEl);

        card.appendChild(thumb);
        card.appendChild(caption);

        if(editMode){
          const badges = document.createElement('div'); badges.className='edit-badges';
          const pill = document.createElement('span'); pill.className='pill'; pill.textContent = `#${idx+1}`; badges.appendChild(pill);
          card.appendChild(badges);

          const actions = document.createElement('div'); actions.className='actions';
          const drag = document.createElement('button'); drag.type='button'; drag.className='icon-btn'; drag.title='Drag to reorder'; drag.innerHTML='‚ÜïÔ∏è';
          const edit = document.createElement('button'); edit.type='button'; edit.className='icon-btn'; edit.title='Edit'; edit.innerHTML='‚úèÔ∏è';
          const del = document.createElement('button'); del.type='button'; del.className='icon-btn'; del.title='Delete'; del.innerHTML='üóëÔ∏è';
          actions.append(drag, edit, del); card.appendChild(actions);

          card.addEventListener('click', (e)=>{
            if(!e.target.closest('.icon-btn')){
              if(e.preventDefault) e.preventDefault();
              e.stopPropagation();
            }
          });

          edit.addEventListener('click', (e)=>{ e.stopPropagation(); openEditor(link.id); });
          del.addEventListener('click', (e)=>{ e.stopPropagation(); confirmDelete(link.id); });

          card.addEventListener('dragstart', (e)=>{
            card.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', link.id);
          });
          card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
          card.addEventListener('dragover', (e)=>{ e.preventDefault(); card.classList.add('drop-target'); e.dataTransfer.dropEffect='move'; });
          card.addEventListener('dragleave', ()=> card.classList.remove('drop-target'));
          card.addEventListener('drop', (e)=>{
            e.preventDefault(); card.classList.remove('drop-target');
            const fromId = e.dataTransfer.getData('text/plain');
            const toId = link.id;
            reorder(fromId, toId);
          });
        }

        grid.appendChild(card);
      });

      if(list.length === 0){
        const empty = document.createElement('div');
        empty.style.opacity = .7; empty.style.textAlign='center'; empty.textContent = 'No links match your search.';
        grid.appendChild(empty);
      }
    }

    function reorder(fromId, toId){
      if(fromId === toId) return;
      const fromIdx = links.findIndex(l=>l.id===fromId);
      const toIdx = links.findIndex(l=>l.id===toId);
      if(fromIdx < 0 || toIdx < 0) return;
      const [moved] = links.splice(fromIdx,1);
      links.splice(toIdx,0,moved);
      save();
      render(searchInput.value);
    }

    function openEditor(id=null){
      editingId = id;
      if(id){
        const l = links.find(x=>x.id===id) || {};
        nameInput.value = l.name || '';
        urlInput.value = l.url || '';
        iconInput.value = l.icon || '';
        updateIconPreview(l.icon || '');
        dlgTitle.textContent = 'Edit Link';
      } else {
        nameInput.value = '';
        urlInput.value = '';
        iconInput.value = '';
        updateIconPreview('');
        dlgTitle.textContent = 'Add Link';
      }
      editor.showModal();
      setTimeout(()=> nameInput.focus(), 50);
    }

    function confirmDelete(id){
      const l = links.find(x=>x.id===id);
      if(!l) return;
      if(confirm(`Delete ‚Äú${l.name}‚Äù?`)){
        links = links.filter(x=>x.id!==id);
        save();
        render(searchInput.value);
      }
    }

    function updateIconPreview(src){
      if (src) {
        iconPreview.src = src;
        iconPreview.style.display = 'inline-block';
      } else {
        iconPreview.removeAttribute('src');
        iconPreview.style.display = 'none';
      }
    }
    iconInput.addEventListener('input', ()=>{
      const v = iconInput.value.trim();
      updateIconPreview(v || '');
    });
    function imageFileToDataURL(file){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onload = ()=> resolve(fr.result);
        fr.onerror = ()=> reject(new Error('Failed to read file'));
        fr.readAsDataURL(file);
      });
    }
    if(iconFile){
      iconFile.addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          const dataUrl = await imageFileToDataURL(file);
          iconInput.value = dataUrl;
          updateIconPreview(dataUrl);
        }catch(err){ alert('Could not load image.'); }
      });
    }
    clearIconBtn.addEventListener('click', ()=>{
      iconInput.value = '';
      updateIconPreview('');
    });

    ['click','auxclick','mousedown','mouseup'].forEach((type)=>{
      document.addEventListener(type, (e)=>{
        if(!editMode) return;
        const allow = e.target && (
          e.target.closest('dialog') ||
          e.target.closest('header') ||
          e.target.closest('.icon-btn') ||
          e.target.closest('#editorForm')
        );
        if(allow) return;

        const onCard = e.target && e.target.closest && e.target.closest('.card');
        if(onCard){
          e.preventDefault();
          e.stopPropagation();
          if(typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
        }
      }, true);
    });

    addBtn.addEventListener('click', ()=> openEditor());
    editToggle.addEventListener('click', ()=>{
      editMode = !editMode;
      editToggle.setAttribute('aria-pressed', String(editMode));
      render(searchInput.value);
    });
    exportBtn.addEventListener('click', ()=>{
      const payload = { title: pageTitle.value, links };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'start-page-links.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });
    importFile.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        if(Array.isArray(data.links)){
          links = data.links
            .filter(x => x && typeof x.name==='string' && typeof x.url==='string')
            .map(x => sanitizeLink({ id: x.id || uid(), name: x.name, url: x.url, icon: x.icon }));
          if(links.length === 0) throw new Error('No usable links in file.');
          save();
          if(typeof data.title === 'string'){ pageTitle.value = data.title; saveTitle(); }
          render(searchInput.value);
        } else if(Array.isArray(data)){
          links = data.map(x => sanitizeLink({ id: x.id || uid(), name: x.name, url: x.url, icon: x.icon }));
          save(); render(searchInput.value);
        } else {
          alert('Import file format not recognized.');
        }
      }catch(err){
        console.error(err); alert('Import failed: ' + err.message);
      } finally {
        importFile.value = '';
      }
    });
    resetBtn.addEventListener('click', ()=>{
      if(confirm('Restore starter links? This will replace your current list.')){
        links = starterData(); save(); render(searchInput.value);
      }
    });
    editorForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const name = norm(nameInput.value);
      const url = norm(urlInput.value);
      let icon = norm(iconInput.value);
      if(!name || !url) return;
      try{ new URL(url); }catch{ alert('Please enter a valid URL (include https://)'); return; }
      if(!icon) icon = undefined;

      if(editingId){
        const idx = links.findIndex(l=>l.id===editingId);
        if(idx>-1){ links[idx] = { ...links[idx], name, url, ...(icon ? {icon} : {icon: undefined}) }; }
      } else {
        const obj = { id: uid(), name, url, ...(icon ? {icon} : {}) };
        links.push(obj);
      }
      save();
      render(searchInput.value);
      editingId = null;
      editor.close();
    });
    editor.addEventListener('close', ()=>{ editingId = null; });
    searchInput.addEventListener('input', ()=> render(searchInput.value));

    window.addEventListener('keydown', (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault(); searchInput.focus(); searchInput.select();
      }
    });
    pageTitle.addEventListener('input', ()=> localStorage.setItem(TITLE_KEY, pageTitle.value));

    load(); save(); render();
  })();
  </script>
</body>
</html>
